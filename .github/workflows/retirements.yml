name: Get Model Retirements

on:
  push:
    branches:
      - main
  schedule:
    # Midnight EST = 05:00 UTC
    - cron: "0 5 * * *"
  workflow_dispatch:

permissions:
  contents: write  # Allow pushing updated RSS feed to the repository

jobs:
  scrape-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run scraper
        run: |
          python scrape.py

      - name: Create index.html for GitHub Pages
        run: |
          cat > output/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>AI Model Retirements RSS Feed</title>
            <style>
              body { font-family: system-ui, -apple-system, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
              a { color: #0366d6; }
            </style>
          </head>
          <body>
            <h1>AI Model Retirements RSS Feed</h1>
            <p>Subscribe to this feed to get updates on AI model retirements from Azure, AWS, and Anthropic Claude.</p>
            <p><strong>RSS Feed URL:</strong> <a href="rss.xml">https://nlinc1905.github.io/ai-model-retirements-rss/rss.xml</a></p>
            <p>Copy the link above to add it to your RSS reader, or download the data in CSV form using the link below.</p>
            <p><strong>CSV URL:</strong> <a href="model_retirements.csv">https://nlinc1905.github.io/ai-model-retirements-rss/model_retirements.csv</a></p>
          </body>
          </html>
          EOF

      - name: Commit updated RSS
        run: |
          if [ -f output/rss.xml ]; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add output/rss.xml output/model_retirements.csv
            if [ -f output/model_retirements_changes.csv ]; then
              git add output/model_retirements_changes.csv
            fi
            git commit -m "Update model retirement RSS feed" || exit 0
            git push
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
